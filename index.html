<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SI√äU CUP *TH KH√ÅNH B√åNH* - Cloud Storage</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #2ecc71; --mouse-color: #3498db; --kb-color: #e74c3c; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* M√†n h√¨nh Menu ch√≠nh & C√†i ƒë·∫∑t */
        .admin-container { 
            position: absolute; inset: 0; background: #2c3e50; z-index: 1000; 
            display: flex; flex-direction: column; align-items: center; padding: 20px; 
            overflow-y: auto; text-align: center;
        }
        textarea { width: 90%; height: 150px; border-radius: 10px; padding: 10px; font-size: 14px; margin: 10px 0; }
        .btn-main { background: var(--primary); color: white; padding: 12px 30px; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; margin: 10px 0; }
        
        .set-item { 
            background: rgba(255,255,255,0.1); width: 90%; max-width: 500px; 
            padding: 15px; margin: 8px; border-radius: 15px; border-left: 6px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* S√¢n v·∫≠n ƒë·ªông (Gi·ªØ nguy√™n giao di·ªán c·ªßa b·∫°n) */
        #game-screen { width: 100vw; height: 100vh; background: radial-gradient(circle, #2d5a27 0%, #1a3c15 100%); position: relative; }
        #stadium-header { background: rgba(0,0,0,0.8); padding: 15px; border-bottom: 5px solid #f1c40f; text-align: center; }
        #question-text { font-size: 28px; color: #fff; font-weight: bold; }

        #goal-area { 
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%); 
            width: 85%; height: 50%; border: 12px solid #fff; border-bottom: none; 
            background: rgba(255,255,255,0.1); border-radius: 15px 15px 0 0; 
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; z-index: 5; 
        }
        
        .target { 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            transition: 0.3s; color: white; border: 1px dashed rgba(255,255,255,0.2); 
            position: relative; padding: 20px; text-align: center;
        }
        .ans-content { font-size: 32px; font-weight: bold; text-shadow: 2px 2px 4px #000; }
        .target-label { position: absolute; top: 5px; left: 5px; background: gold; padding: 2px 10px; color: #000; border-radius: 4px; font-weight: bold; }

        #ball { position: absolute; bottom: 8%; left: 50%; width: 70px; height: 70px; font-size: 60px; display: flex; align-items: center; justify-content: center; transform: translateX(-50%); z-index: 10; transition: all 0.5s; }

        #scoreboard { position: absolute; bottom: 0; width: 100%; display: flex; justify-content: space-between; padding: 15px; box-sizing: border-box; }
        .team-score { padding: 10px; border-radius: 15px; font-size: 20px; width: 200px; text-align: center; border: 3px solid #fff; }

        #announcement { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; font-weight: 900; display: none; z-index: 100; text-align: center; width: 100%; }
        #final-winner { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="main-menu" class="admin-container">
    <h1 style="color: #f1c40f;">‚öΩ SI√äU C√öP _TH KH√ÅNH B√åNH</h1>
    <div id="set-list" style="width: 100%; display: flex; flex-direction: column; align-items: center;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    <hr style="width: 80%; margin: 20px 0;">
    <button class="btn-main" onclick="showSetup()">‚ûï T·∫†O B·ªò C√ÇU H·ªéI M·ªöI</button>
</div>

<div id="setup-screen" class="admin-container hidden">
    <button onclick="showMenu()" style="align-self: flex-start; background: #6c757d; color:white; border:none; padding:10px; border-radius:10px;">‚¨Ö Quay l·∫°i</button>
    <h2>Thi·∫øt l·∫≠p c√¢u h·ªèi</h2>
    <input type="text" id="set-name" placeholder="T√™n b·ªô (VD: To√°n l·ªõp 5)" style="width: 90%; padding: 10px; border-radius: 10px;">
    <p style="font-size: 13px;">ƒê·ªãnh d·∫°ng: C√¢u h·ªèi | A | B | C | D | Ch·ªâ s·ªë ƒë√∫ng (0-3)</p>
    <textarea id="input-data" placeholder="V√≠ d·ª•: 1+1 b·∫±ng m·∫•y?|1|2|3|4|1"></textarea>
    <button class="btn-main" onclick="saveToCloud()">üíæ L∆ØU L√äN CLOUD & B·∫ÆT ƒê·∫¶U</button>
</div>

<div id="game-screen" class="hidden">
    <div id="stadium-header"><div id="question-text"></div></div>
    <div id="goal-area">
        <div class="target" onclick="shoot('mouse', 0)" id="t0"><span class="target-label">A</span><div class="ans-content"></div></div>
        <div class="target" onclick="shoot('mouse', 1)" id="t1"><span class="target-label">B</span><div class="ans-content"></div></div>
        <div class="target" onclick="shoot('mouse', 2)" id="t2"><span class="target-label">C</span><div class="ans-content"></div></div>
        <div class="target" onclick="shoot('mouse', 3)" id="t3"><span class="target-label">D</span><div class="ans-content"></div></div>
    </div>
    <div id="ball">‚öΩ</div>
    <div id="scoreboard">
        <div class="team-score" style="background:var(--mouse-color)">üñ±Ô∏è CHU·ªòT: <span id="score-mouse">0</span></div>
        <button onclick="location.reload()" style="background:none; border:1px solid white; color:white; cursor:pointer; border-radius:10px;">Tho√°t</button>
        <div class="team-score" style="background:var(--kb-color)">‚å®Ô∏è PH√çM: <span id="score-kb">0</span></div>
    </div>
    <div id="announcement">V√ÄOOO!!!</div>
</div>

<div id="final-winner">
    <h1 id="winner-text" style="font-size: 60px; color: gold;"></h1>
    <p id="final-score" style="font-size: 30px; color: white;"></p>
    <button class="btn-main" onclick="location.reload()">QUAY L·∫†I MENU</button>
</div>

<audio id="snd-goal" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
<audio id="snd-miss" src="https://assets.mixkit.co/active_storage/sfx/2012/2012-preview.mp3"></audio>
<audio id="snd-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>
<audio id="snd-kick" src="https://assets.mixkit.co/active_storage/sfx/2042/2042-preview.mp3"></audio>

<script>
    // C·∫•u h√¨nh Firebase (D√πng chung b·ªô nh·ªõ v·ªõi c√°c game kh√°c c·ªßa b·∫°n)
    const firebaseConfig = {
        apiKey: "AIzaSyCWwXbgWOZTifn-pRM57HZ2RiqHjWZ6DgE",
        authDomain: "gamekeotha.firebaseapp.com",
        databaseURL: "https://gamekeotha-default-rtdb.firebaseio.com",
        projectId: "gamekeotha",
        storageBucket: "gamekeotha.firebasestorage.app",
        messagingSenderId: "294617757747",
        appId: "1:294617757747:web:b1592f8fb6743ea3f88b46"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let questions = [];
    let currentQ = 0;
    let scores = { mouse: 0, kb: 0 };
    let canShoot = true;
    let allSets = {};

    // T·∫£i danh s√°ch b·ªô c√¢u h·ªèi t·ª´ Cloud
    db.ref('soccer_quiz_sets').on('value', snap => {
        allSets = snap.val() || {};
        renderList();
    });

    function renderList() {
        const list = document.getElementById('set-list');
        list.innerHTML = "";
        for (let key in allSets) {
            const div = document.createElement('div');
            div.className = 'set-item';
            div.innerHTML = `
                <span><b>${allSets[key].name}</b></span>
                <div>
                    <button onclick="playSet('${key}')" style="background:#2ecc71; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">ƒê√Å B√ìNG</button>
                    <button onclick="deleteSet('${key}')" style="background:#e74c3c; color:white; border:none; padding:8px; border-radius:8px; cursor:pointer; margin-left:5px;">X√≥a</button>
                </div>
            `;
            list.appendChild(div);
        }
    }

    function saveToCloud() {
        const name = document.getElementById('set-name').value.trim();
        const text = document.getElementById('input-data').value.trim();
        if(!name || !text) return alert("Vui l√≤ng nh·∫≠p t√™n b·ªô v√† c√¢u h·ªèi!");

        db.ref('soccer_quiz_sets').push({ name, data: text }).then(() => {
            showMenu();
        });
    }

    function deleteSet(key) { if(confirm("X√≥a b·ªô n√†y?")) db.ref('soccer_quiz_sets/' + key).remove(); }

    function playSet(key) {
        const text = allSets[key].data;
        questions = text.split('\n').filter(l => l.includes('|')).map(line => {
            const parts = line.split('|');
            const correct = parts.pop();
            const opts = parts.slice(1);
            return { q: parts[0], options: opts, correct: parseInt(correct) };
        });

        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        loadQuestion();
    }

    // --- LOGIC TR√í CH∆†I ---
    function loadQuestion() {
        if(currentQ >= questions.length) return endMatch();
        canShoot = true;
        resetBall();
        document.getElementById('question-text').innerText = `C√¢u ${currentQ+1}: ${questions[currentQ].q}`;
        for(let i=0; i<4; i++) {
            const target = document.getElementById('t'+i);
            target.querySelector('.ans-content').innerText = questions[currentQ].options[i] || "";
        }
    }

    function resetBall() {
        const ball = document.getElementById('ball');
        ball.style.transition = 'none';
        ball.style.bottom = '8%'; ball.style.left = '50%'; ball.style.top = 'auto';
        ball.style.fontSize = '60px'; ball.style.transform = 'translateX(-50%)';
        void ball.offsetWidth;
        ball.style.transition = 'all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
    }

    function shoot(team, index) {
        if (!canShoot) return;
        canShoot = false;
        document.getElementById('snd-kick').play().catch(()=>{});

        const ball = document.getElementById('ball');
        const target = document.getElementById('t' + index).getBoundingClientRect();
        ball.style.left = (target.left + target.width/2) + 'px';
        ball.style.top = (target.top + target.height/2) + 'px';
        ball.style.fontSize = '30px';

        setTimeout(() => {
            const isCorrect = (index === questions[currentQ].correct);
            const msg = document.getElementById('announcement');
            if(isCorrect) {
                scores[team] += 10;
                document.getElementById('snd-goal').play();
                msg.innerText = "V√ÄOOO!!!"; msg.style.color = "#f1c40f";
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            } else {
                scores[team] -= 5;
                document.getElementById('snd-miss').play();
                msg.innerText = "KH√îNG V√ÄO!!"; msg.style.color = "#e74c3c";
            }
            document.getElementById('score-' + team).innerText = scores[team];
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
                currentQ++;
                loadQuestion();
            }, 3000);
        }, 500);
    }

    function endMatch() {
        document.getElementById('game-screen').classList.add('hidden');
        const final = document.getElementById('final-winner');
        final.style.display = 'flex';
        document.getElementById('snd-win').play();
        let winnerMsg = scores.mouse > scores.kb ? "üèÜ ƒê·ªòI CHU·ªòT TH·∫ÆNG!" : (scores.kb > scores.mouse ? "üèÜ ƒê·ªòI PH√çM TH·∫ÆNG!" : "ü§ù H√íA NHAU!");
        document.getElementById('winner-text').innerText = winnerMsg;
        document.getElementById('final-score').innerText = `Chu·ªôt: ${scores.mouse} - Ph√≠m: ${scores.kb}`;
    }

    // Keyboard h·ªó tr·ª£ Ph√≠m A-D
    document.addEventListener('keydown', (e) => {
        if(!canShoot) return;
        const key = e.key.toUpperCase();
        const map = {'A':0, 'B':1, 'C':2, 'D':3};
        if(map.hasOwnProperty(key)) shoot('kb', map[key]);
    });

    function showSetup() { document.getElementById('main-menu').classList.add('hidden'); document.getElementById('setup-screen').classList.remove('hidden'); }
    function showMenu() { document.getElementById('setup-screen').classList.add('hidden'); document.getElementById('main-menu').classList.remove('hidden'); }
</script>
</body>
</html>